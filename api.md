Чтобы взаимодействовать с методами для отправки сообщения, чтения бесед и тд., нужно изначально открыть вебсокет-соединение. Просто открыть, нужно, чтобы socket_id попал в кэш.
### Получение сообщений

После подключения нам нужно получить все сообщения глобального чата, мы выполняем запрос к методу:

**[GET]**:
```javascript
/v1/messages/get?chat=0
```

Параметры (тип: **query**, то есть все после ?):
- chat (integer, > 0)
- offset (integer, > 0)

Все параметры являются необязательными.

В качестве ответа получаем объект, содержащий в себе массив messages (до 100 сообщений). Если нужно больше, то прокидываем offset=число:

**[GET]**:
```javascript
/v1/messages/get?chat=0&offset=150
```
> Здесь мы пропускаем 150 сообщений.

**Ошибки**, которые может отдать этот метод:  
1 - Прокиньте айдишник чата (?chat=0)  
2 - Такой беседы нет (если chat не равен 0)  
3 - Вы не участник этой беседы  
4 - Сперва создайте вебсокет-подключение

Примечание: если получить сообщения глобального чата, то система автоматически подпишет его на рассылку уведомлений (ну типо в комнату вебсокета закинет). То есть можно сделать анонимный чат необязательным, как это было ранее.  

*Данные об отправителе отдаются везде, кроме как в анонимном чате.*

### Отправка сообщений

Отправляем запрос на endpoint:  
**[POST]**:
```javascript
/v1/messages/send
```

Параметры (* - обязательный):
- *text (string, 1-1000)
- conversation_id (integer, < 100000000 & > 0)

Если не прокидывать conversation_id, то будет выбран глобальный чат (анонимный который).

Ошибки, которые может отдать этот метод:  
1 - Такой беседы нет  
2 - Нет прав писать в этой беседе  
3 - Сперва создайте вебсокет-подключение

Ответ стандартный:
```javascript
{response: true}
```

### Беседы. Получение.
Отправляем запрос на endpoint:  
**[GET]**:
```javascript
/v1/conversations/get
```

Параметры (все параметры являются необязательными, но рекомендуются к передаче (кроме offset)). Тип параметров: **query**.
- mode (string, *варианты:* ***joined***, ***new***)
- offset (integer, > 0)

Параметр **mode** будет запрашивать:
- **joined** - все беседы, в которых юзер является участником.
- **new** - все беседы, где юзер не состоит.

Возвращаемые ошибки:  
1 - Сперва создайте вебсокет-подключение  

Ответ: стандартный, но также возвращается массив **conversations**:
```javascript
{response: true, conversations: []}
```

Примечание: метод также возвращает **unreadCount** - количество непрочитанных сообщений, **senderAvatar** - аватарку юзера, который отправил сообщение (можно делать превью диалога как в веб-версии пк диалог) и **message** - собственно, само сообщение.    

*Эти параметры возвращаются только при mode=joined.*

#### Пример:
> [POST] /v1/conversations/get (параметры отсутствуют):
```javascript
{
    "response": true,
        "conversations": [
        {
            "id": 7,
            "name": "Беседа для жабаскриптеров",
            "members": 2,
            "unreadCount": 0,
            "message": "hello!2",
            "senderAvatar": "https://sun9-36.userapi.com/sun9-34/s/v1/ig2/d-cj7dPdES1QVmnzhVwQt1l_GcBecMN9BDUbYZAowhoiDFoIwMok75vQcww6Ryc-k0fWkyizlR4lzCpQZeNpyPIf.jpg?size=100x100&quality=95&crop=0,0,1280,1280&ava=1"
        },
        {
            "id": 13,
            "name": "Беседа для жабаскриптеров №2",
            "members": 1,
            "unreadCount": 3,
            "message": "Тестовое сообщение через API!",
            "senderAvatar": "https://sun9-36.userapi.com/sun9-34/s/v1/ig2/d-cj7dPdES1QVmnzhVwQt1l_GcBecMN9BDUbYZAowhoiDFoIwMok75vQcww6Ryc-k0fWkyizlR4lzCpQZeNpyPIf.jpg?size=100x100&quality=95&crop=0,0,1280,1280&ava=1"
        }
    ]
}
```  
> [POST] /v1/conversations/get?mode=new:
```javascript
{
    "response": true,
        "conversations": [
        {
            "id": 14,
            "name": "Беседа для жабаскриптеров №3",
            "members": 0
        }
    ]
}
```

### Беседы. Вступление.
В методы выше я отдаю **id** беседы, который нам сейчас и пригодится.  

Отправляем запрос на endpoint:  
**[GET]**:
```javascript
/v1/conversations/join/:conversation_id
```
> :conversation_id - просто параметр, который нужно прокинуть. Это, кстати, **единственный** параметр этого метода.

Возвращаемые ошибки:  
1 - Такой беседы нет  
2 - Вы уже участник этой беседы  
3 - Слишком много участников  
4 - Сперва создайте вебсокет-подключение

Ответ: стандартный, но также возвращается массив **messages** с последними сообщениями (до 100).

Примечание: после вступления в беседу отправляется event всем соединениям:
```javascript
"joined_conversation", { conversation_id: 13, user_id: 172118960, avatar: "...", name: "Никита Балин" }
```
> На фронте нужно менять счетчик участников и в информации о беседе менять участников (докидывать нового пользователя).

#### Пример:
> [GET] /v1/conversations/join/7
```javascript
{
    "response": true,
    "messages": [
        {
            "id": 12,
            "name": "Никита Балин",
            "avatar": "https://sun9-36.userapi.com/sun9-34/s/v1/ig2/d-cj7dPdES1QVmnzhVwQt1l_GcBecMN9BDUbYZAowhoiDFoIwMok75vQcww6Ryc-k0fWkyizlR4lzCpQZeNpyPIf.jpg?size=100x100&quality=95&crop=0,0,1280,1280&ava=1",
            "user_id": 172118960,
            "message": "hello!",
            "time": 1639741832
        },
        {
            "id": 13,
            "name": "Никита Балин",
            "avatar": "https://sun9-36.userapi.com/sun9-34/s/v1/ig2/d-cj7dPdES1QVmnzhVwQt1l_GcBecMN9BDUbYZAowhoiDFoIwMok75vQcww6Ryc-k0fWkyizlR4lzCpQZeNpyPIf.jpg?size=100x100&quality=95&crop=0,0,1280,1280&ava=1",
            "user_id": 172118960,
            "message": "hello!2",
            "time": 1639741873
        }
    ]
}
```
### Беседы. Выход.
Естественно, пользователи захотят выйти из какой-либо беседы: освободить слот или им просто надоест. Для этого и создан этот метод.

Отправляем запрос на endpoint:  
**[GET]**:
```javascript
/v1/conversations/leave/:conversation_id
```
> :conversation_id - просто параметр, который нужно прокинуть. Это, кстати, **единственный** параметр этого метода.

Возвращаемые ошибки:  
1 - Такой беседы нет  
2 - Вы не участник этой беседы  
3 - Сперва создайте вебсокет-подключение

Ответ стандартный:
```javascript
{response: true}
```

Примечание: после выхода всем отправляется event:
```javascript
"leaved_conversation", { conversation_id: 13, user_id: 172118960 }
```
> На фронте нужно менять счетчик участников и в информации о беседе удалять участников.


Примечание №2: если выйдут все пользователи из беседы (то есть их останется **0**), то беседа **удалится вместе с сообщениями**.  

*Да будет защита данных!*

### Беседы. Создание.
В описании не нуждается.

Отправляем запрос на endpoint:  
**[POST]**:
```javascript
/v1/conversations/new
```
Параметры, которые нужно прокинуть:
- name (string, 3-50)

Возможные ошибки:  
1 - Беседа с таким **name** и **user_id** уже создана  
2 - Сперва создайте вебсокет-подключение

Примечание: после создания беседы всем слушателям придет event. В event'е не прокидывается **message**, т.к. при создании беседы там появляется дефолтное сообщение: "Создана беседа."
```javascript
"new_conversation", { name: "Назавние", conversation_id: 13, members: 1, senderAvatar: "..." }
```
> На фронте нужно добавить этот чат в список новые и текущие (у создателя беседы).

### Беседы. Удаление.
Админ (=== создатель) может в любой момент удалить беседу, даже если в ней будет хоть 5 человек и 300 зрителей.

Отправляем запрос на endpoint:  
**[DELETE]**:
```javascript
/v1/conversations/delete/:conversation_id
```
> :conversation_id - просто параметр, который нужно прокинуть. Это, кстати, **единственный** параметр этого метода.

Возвращаемые ошибки:  
1 - Такой беседы нет  
2 - Нет прав   
3 - Сперва создайте вебсокет-подключение

Ответ стандартный:
```javascript
{response: true}
```

Примечание: после удаления беседы **все пользователи в онлайне** получат websocket-сообщение. Например:
```javascript
"delete_conversation", { conversation_id: 13 }
```
> На фронте нужно выкинуть из чата всех участников, которые там сидят и вообще удалить из списка этот чат (новые/активные беседы).

### Беседы. Просмотр (зрители).
Пользователи с этими правами **не могут** писать в чат и видят лишь последние **50 сообщений**. После входа в чат для них создается специальная websocket-комната, которая будет активна до выполнения следующего метода (его нужно отправлять после закрытия чата).

Отправляем запрос на endpoint:  
**[GET]**:
```javascript
/v1/conversations/view/:conversation_id
```
> :conversation_id - просто параметр, который нужно прокинуть. Это, кстати, **единственный** параметр этого метода.

Возвращаемые ошибки:  
1 - Такой беседы нет  
2 - Вы уже участник этой беседы  
3 - Сперва создайте вебсокет-подключение 

Ответ стандартный, но также отдаются последние сообщения (до 50). Пример массива с сообщениями в **/v1/messages/get**.

Примечание: после захода в беседу в качестве зрителя все участники получают event:
```javascript
"conversationViewersChange", { conversation_id: 13, viewers: 3 }
```
> На фронте нужно отобразить количество зрителей как в списке чатов, так и внутри самого чата.

### Беседы. Завершения просмотра (покидание чата).
*Покинула чат-чат-чат-чат*

Отправляем запрос на endpoint:
**[GET]**:
```javascript
/v1/conversations/stopView/:conversation_id
```
> :conversation_id - просто параметр, который нужно прокинуть. Это, кстати, **единственный** параметр этого метода.

Возвращаемые ошибки:  
1 - Такой беседы нет  
2 - Вы уже участник этой беседы  
3 - Сперва создайте вебсокет-подключение

Ответ стандартный.  

Примечание: после выхода из просмотра беседы все участники получают event:
```javascript
"conversationViewersChange", { conversation_id: 13, viewers: 3 }
```
> На фронте нужно отобразить количество зрителей как в списке чатов, так и внутри самого чата.


### Беседы. Чтение.
Этот запрос нужно выполнять при каждом получении сообщения, если пользователь находится в беседе. Можно и через 1, тут уже играет роль оптимизация. Если нет - добавляем к счётчику сообщений +1 до момента открытия чата.  

То есть в последнем случае при открытии чата будет выполнять 2 запроса: **/v1/messages/get** и **/v1/conversations/read**.

Отправляем запрос на endpoint:  
**[GET]**:
```javascript
/v1/conversations/read/:conversation_id
```
> :conversation_id - просто параметр, который нужно прокинуть. Это, кстати, **единственный** параметр этого метода.

Возвращаемые ошибки:  
1 - Такой беседы нет  
2 - Вы не участник этой беседы  
3 - Сперва создайте вебсокет-подключение 

Ответ стандартный.